{% extends 'base.html' %}
{% load static %}

{% block title %}Gestionar Imágenes - {{ product.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products/admin_products.css' %}">
<link rel="stylesheet" href="{% static 'css/products/admin_product_images.css' %}">
{% endblock %}


{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item"><a href="{% url 'products:admin_product_list' %}"><i class="fas fa-boxes"></i> Productos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'products:admin_product_edit' product.id %}">{{ product.name }}</a></li>
            <li class="breadcrumb-item active">Gestionar Imágenes</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="admin-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="admin-title">
                    <i class="fas fa-images"></i> Gestionar Imágenes
                </h1>
                <p class="text-muted mb-0">Administra las imágenes de tu producto</p>
            </div>
            <div class="col-md-4 text-md-right">
                <a href="{% url 'products:admin_product_list' %}" class="btn btn-secondary mr-2">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a href="{% url 'products:admin_product_edit' product.id %}" class="btn btn-info">
                    <i class="fas fa-edit"></i> Editar Producto
                </a>
            </div>
        </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} mr-2"></i>
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Formulario para agregar nuevas imágenes -->
            <div class="card shadow-sm mb-4">
                <div class="section-header">
                    <i class="fas fa-cloud-upload-alt"></i> Agregar Nuevas Imágenes
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" action="{% url 'products:admin_product_images_upload' product.id %}" id="uploadForm">
                        {% csrf_token %}
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4 class="mb-3">Arrastra y suelta imágenes aquí</h4>
                            <p class="text-muted mb-4">o selecciona archivos desde tu computadora</p>
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('imageInput').click()">
                                <i class="fas fa-folder-open"></i> Seleccionar Imágenes
                            </button>
                            <input type="file" class="d-none" id="imageInput" name="images" multiple accept="image/*">
                        </div>
                        
                        <div id="previewContainer"></div>
                        
                        <div class="upload-progress" id="uploadProgress">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 100%">
                                    <i class="fas fa-spinner fa-spin"></i> Subiendo imágenes...
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center" id="uploadButtonContainer" style="display: none;">
                            <button type="submit" class="btn btn-success btn-lg px-5" onclick="return confirmUpload(event)">
                                <i class="fas fa-upload"></i> Subir <span id="imageCount">0</span> Imagen(es)
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="confirmCancelUpload()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información:</strong> Formatos soportados: JPG, PNG, GIF, WebP | Tamaño máximo: 5MB por imagen
                    </div>
                </div>
            </div>

            <!-- Lista de imágenes existentes -->
            <div class="card shadow-sm">
                <div class="section-header">
                    <i class="fas fa-th-large"></i> Imágenes Actuales 
                    <span class="badge badge-light ml-2">{{ product.images.count }}</span>
                </div>
                <div class="card-body p-4">
                    {% if product.images.all %}
                    <div class="row">
                        {% for image in product.images.all %}
                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card image-card">
                                <div class="image-wrapper">
                                    {% if image.is_main %}
                                    <span class="badge badge-success main-badge">
                                        <i class="fas fa-star"></i> Principal
                                    </span>
                                    {% endif %}
                                    <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.alt_text }}" loading="lazy">
                                </div>
                                <div class="card-body">
                                    <form method="post" action="{% url 'products:admin_product_image_update' product.id image.id %}">
                                        {% csrf_token %}
                                        <div class="form-group mb-3">
                                            <label class="small font-weight-bold text-muted">
                                                <i class="fas fa-tag"></i> Texto Alternativo:
                                            </label>
                                            <input type="text" class="form-control form-control-sm" 
                                                   name="alt_text" value="{{ image.alt_text }}"
                                                   placeholder="Descripción de la imagen">
                                        </div>
                                        <div class="custom-control custom-switch mb-3">
                                            <input type="checkbox" class="custom-control-input" 
                                                   id="is_main_{{ image.id }}" name="is_main" 
                                                   {% if image.is_main %}checked{% endif %}>
                                            <label class="custom-control-label font-weight-bold" for="is_main_{{ image.id }}">
                                                <i class="fas fa-star"></i> Imagen Principal
                                            </label>
                                        </div>
                                        <div class="btn-group-vertical">
                                            <button type="submit" class="btn btn-sm btn-info" onclick="return confirmUpdate(event, this)">
                                                <i class="fas fa-save"></i> Guardar Cambios
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" 
                                                    data-toggle="modal" 
                                                    data-target="#deleteImageModal{{ image.id }}">
                                                <i class="fas fa-trash-alt"></i> Eliminar Imagen
                                            </button>
                                        </div>
                                    </form>
                                    <small class="text-muted d-block mt-3 text-center">
                                        <i class="far fa-calendar"></i> {{ image.created_at|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                            </div>

                            <!-- Modal de Eliminación -->
                            <div class="modal fade" id="deleteImageModal{{ image.id }}" tabindex="-1" role="dialog">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">
                                                <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                                            </h5>
                                            <button type="button" class="close text-white" data-dismiss="modal">
                                                <span>&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body text-center py-4">
                                            <img src="{{ image.image.url }}" alt="Preview" 
                                                 style="max-width: 100%; max-height: 250px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                            <h5>¿Eliminar esta imagen?</h5>
                                            <p class="text-muted">Esta acción no se puede deshacer.</p>
                                            {% if image.is_main %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                Esta es la imagen principal del producto
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                <i class="fas fa-times"></i> Cancelar
                                            </button>
                                            <form method="post" action="{% url 'products:admin_product_image_delete' product.id image.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fas fa-trash"></i> Eliminar Imagen
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-images"></i>
                        <h4 class="text-muted mb-3">No hay imágenes</h4>
                        <p class="text-muted mb-4">Este producto aún no tiene imágenes.</p>
                        <p class="text-muted">Usa el formulario de arriba para agregar imágenes.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Información del producto -->
            <div class="product-info-card mb-4">
                <h5><i class="fas fa-box"></i> {{ product.name }}</h5>
                <hr class="bg-white">
                <p><strong><i class="fas fa-tag"></i> Categoría:</strong> {{ product.category.name }}</p>
                <p><strong><i class="fas fa-dollar-sign"></i> Precio:</strong> ${{ product.price }}</p>
                <p><strong><i class="fas fa-boxes"></i> Stock:</strong> {{ product.stock }} unidades</p>
                <p class="mb-0">
                    <strong><i class="fas fa-images"></i> Total de imágenes:</strong> 
                    <span class="badge badge-light badge-pill">{{ product.images.count }}</span>
                </p>
            </div>

            <!-- Guía Rápida -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Guía Rápida</h5>
                </div>
                <div class="card-body">
                    <h6 class="font-weight-bold mb-3">Cómo gestionar imágenes:</h6>
                    <ol class="pl-3">
                        <li class="mb-2">Arrastra archivos o haz clic en "Seleccionar Imágenes"</li>
                        <li class="mb-2">Previsualiza las imágenes antes de subir</li>
                        <li class="mb-2">Define una imagen como principal marcando el checkbox</li>
                        <li class="mb-2">Agrega texto alternativo para mejor SEO</li>
                        <li>Elimina imágenes que ya no necesites</li>
                    </ol>
                    
                    <hr>
                    
                    <h6 class="font-weight-bold mb-2">
                        <i class="fas fa-lightbulb text-warning"></i> Consejos:
                    </h6>
                    <ul class="pl-3 mb-0">
                        <li class="mb-2">La imagen principal aparece en listados</li>
                        <li class="mb-2">Usa imágenes de alta calidad</li>
                        <li class="mb-2">Recomendado: mínimo 3 imágenes por producto</li>
                        <li>Optimiza el tamaño antes de subir</li>
                    </ul>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Estadísticas</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-images"></i> Total:</span>
                        <strong>{{ product.images.count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-star"></i> Principal:</span>
                        <strong>{% if product.images.filter.is_main %}1{% else %}0{% endif %}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-check-circle"></i> Estado:</span>
                        <strong class="{% if product.images.count > 0 %}text-success{% else %}text-warning{% endif %}">
                            {% if product.images.count > 0 %}Completo{% else %}Incompleto{% endif %}
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadButtonContainer = document.getElementById('uploadButtonContainer');
    const imageCount = document.getElementById('imageCount');
    let selectedFiles = [];

    // Prevenir comportamiento por defecto
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight en drag over
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('dragover');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('dragover');
        }, false);
    });

    // Manejar drop
    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    });

    // Manejar selección de archivos
    imageInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        const filesArray = Array.from(files);
        
        filesArray.forEach(file => {
            if (file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`El archivo ${file.name} excede el tamaño máximo de 5MB`, 'warning');
                    return;
                }
                selectedFiles.push(file);
                displayPreview(file);
            } else {
                showNotification(`El archivo ${file.name} no es una imagen válida`, 'error');
            }
        });

        updateFileInput();
        
        if (selectedFiles.length > 0) {
            uploadButtonContainer.style.display = 'block';
            imageCount.textContent = selectedFiles.length;
        }
    }

    function displayPreview(file) {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview" loading="lazy">
                <button type="button" class="remove-preview" onclick="removePreview('${file.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-times"></i>
                </button>
                <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 3px 5px; font-size: 0.7rem; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${file.name}
                </div>
            `;
            previewContainer.appendChild(previewItem);
        };
        
        reader.readAsDataURL(file);
    }

    window.removePreview = function(fileName) {
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);
        updateFileInput();
        updatePreviewDisplay();
        
        if (selectedFiles.length === 0) {
            uploadButtonContainer.style.display = 'none';
        } else {
            imageCount.textContent = selectedFiles.length;
        }
    }

    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => {
            dataTransfer.items.add(file);
        });
        imageInput.files = dataTransfer.files;
    }

    function updatePreviewDisplay() {
        previewContainer.innerHTML = '';
        selectedFiles.forEach(file => {
            displayPreview(file);
        });
    }

    window.clearSelection = function() {
        selectedFiles = [];
        previewContainer.innerHTML = '';
        imageInput.value = '';
        uploadButtonContainer.style.display = 'none';
    }

    // Mostrar progreso al enviar
    uploadForm.addEventListener('submit', (e) => {
        if (selectedFiles.length > 0) {
            uploadProgress.style.display = 'block';
            uploadButtonContainer.style.display = 'none';
            previewContainer.style.opacity = '0.5';
        }
    });

    // Función para mostrar notificaciones
    function showNotification(message, type) {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-warning';
        const icon = type === 'error' ? 'exclamation-circle' : 'exclamation-triangle';
        
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fas fa-${icon} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
        
        // Auto-dismiss después de 5 segundos
        setTimeout(() => {
            $(alert).alert('close');
        }, 5000);
    }

    // Lazy loading para imágenes
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });

        document.querySelectorAll('img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
        });
    }

    // Confirm before leaving if files are selected
    window.addEventListener('beforeunload', (e) => {
        if (selectedFiles.length > 0) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Función para confirmar actualización de imagen
    function confirmUpdate(event, button) {
        const form = button.closest('form');
        const altText = form.querySelector('input[name="alt_text"]').value;
        const isMain = form.querySelector('input[name="is_main"]').checked;
        
        let message = '¿Deseas guardar los cambios en esta imagen?';
        
        if (isMain) {
            message += '\n\nNOTA: Esta imagen se establecerá como principal y las demás perderán ese estado.';
        }
        
        if (!altText || altText.trim() === '') {
            message += '\n\nADVERTENCIA: No has ingresado texto alternativo. Se recomienda agregar uno para mejorar el SEO.';
        }
        
        const confirmed = confirm(message);
        
        if (confirmed) {
            // Agregar estado de carga al botón
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            button.disabled = true;
        }
        
        return confirmed;
    }

    // Función para confirmar subida de imágenes
    function confirmUpload(event) {
        if (selectedFiles.length === 0) {
            alert('Por favor selecciona al menos una imagen para subir.');
            event.preventDefault();
            return false;
        }
        
        const fileNames = selectedFiles.map(f => f.name).join('\n- ');
        const message = `¿Deseas subir ${selectedFiles.length} imagen(es)?\n\nArchivos:\n- ${fileNames}`;
        
        const confirmed = confirm(message);
        
        if (!confirmed) {
            event.preventDefault();
        }
        
        return confirmed;
    }

    // Función para confirmar cancelación de subida
    function confirmCancelUpload() {
        if (selectedFiles.length > 0) {
            const confirmed = confirm(`Tienes ${selectedFiles.length} imagen(es) seleccionada(s).\n\n¿Estás seguro de que deseas cancelar?`);
            
            if (confirmed) {
                clearSelection();
            }
        } else {
            clearSelection();
        }
    }

    // Validar antes de subir el formulario
    uploadForm.addEventListener('submit', (e) => {
        if (selectedFiles.length === 0) {
            e.preventDefault();
            showNotification('Por favor selecciona al menos una imagen antes de subir.', 'error');
            return false;
        }
        
        // Validar tamaño de archivos
        const oversizedFiles = selectedFiles.filter(file => file.size > 5 * 1024 * 1024);
        if (oversizedFiles.length > 0) {
            e.preventDefault();
            showNotification(`Los siguientes archivos exceden el tamaño máximo de 5MB: ${oversizedFiles.map(f => f.name).join(', ')}`, 'error');
            return false;
        }
        
        // Validar tipo de archivo
        const invalidFiles = selectedFiles.filter(file => !file.type.startsWith('image/'));
        if (invalidFiles.length > 0) {
            e.preventDefault();
            showNotification(`Los siguientes archivos no son imágenes válidas: ${invalidFiles.map(f => f.name).join(', ')}`, 'error');
            return false;
        }
        
        if (selectedFiles.length > 0) {
            uploadProgress.style.display = 'block';
            uploadButtonContainer.style.display = 'none';
            previewContainer.style.opacity = '0.5';
        }
    });
</script>
{% endblock %}