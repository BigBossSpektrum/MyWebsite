{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Producto{% endblock %}

{% block extra_css %}
<style>
    .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }
    .image-preview {
        position: relative;
        width: 150px;
        height: 150px;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .image-preview .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .image-preview .remove-image:hover {
        background: rgba(220, 53, 69, 1);
    }
    .drop-zone {
        border: 2px dashed #007bff;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    .drop-zone:hover, .drop-zone.dragover {
        background: #e7f1ff;
        border-color: #0056b3;
    }
    .drop-zone i {
        font-size: 48px;
        color: #007bff;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header">
                    <h3>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Producto</h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="productForm">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        {% for field in form %}
                        <div class="form-group mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {% if field.field.widget.input_type == 'checkbox' %}
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                    </label>
                                </div>
                            {% else %}
                                {{ field }}
                            {% endif %}
                            {% if field.help_text %}
                            <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            {% for error in field.errors %}
                            <div class="invalid-feedback d-block">
                                {{ error }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}

                        <!-- Sección de Imágenes -->
                        <div class="form-group mb-3">
                            <label class="form-label">Imágenes del Producto</label>
                            <div class="drop-zone" id="dropZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p class="mb-2"><strong>Arrastra imágenes aquí o haz clic para seleccionar</strong></p>
                                <p class="text-muted small">Puedes seleccionar múltiples imágenes</p>
                                <input type="file" name="product_images" id="imageInput" multiple accept="image/*" style="display: none;">
                            </div>
                            <small class="form-text text-muted">Formatos soportados: JPG, PNG, GIF. Tamaño máximo por imagen: 5MB</small>
                        </div>

                        <!-- Vista previa de imágenes -->
                        <div id="imagePreviewContainer" class="image-preview-container"></div>

                        {% if product %}
                        <!-- Mostrar imágenes existentes si estamos editando -->
                        <div class="mt-4">
                            <h5>Imágenes Actuales</h5>
                            <div class="image-preview-container">
                                {% for image in product.images.all %}
                                <div class="image-preview">
                                    <img src="{{ image.image.url }}" alt="{{ image.alt_text }}">
                                    {% if image.is_main %}
                                    <span class="badge badge-success" style="position: absolute; top: 5px; left: 5px;">Principal</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <a href="{% url 'products:admin_product_images' product.id %}" class="btn btn-info mt-2">
                                <i class="fas fa-images"></i> Gestionar Imágenes
                            </a>
                        </div>
                        {% endif %}

                        <div class="form-group mt-4">
                            <a href="{% url 'products:admin_product_list' %}" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">
                                {% if form.instance.pk %}Actualizar{% else %}Crear{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Manejo de drag & drop y vista previa de imágenes
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('imagePreviewContainer');
    let selectedFiles = [];

    // Click en la zona de drop para abrir selector de archivos
    dropZone.addEventListener('click', () => {
        imageInput.click();
    });

    // Prevenir comportamiento por defecto del navegador
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight en drag over
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('dragover');
        });
    });

    // Manejar drop de archivos
    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    // Manejar selección de archivos
    imageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        handleFiles(files);
    });

    function handleFiles(files) {
        const fileArray = Array.from(files);
        
        fileArray.forEach(file => {
            if (file.type.startsWith('image/')) {
                selectedFiles.push(file);
                displayPreview(file);
            }
        });

        updateFileInput();
    }

    function displayPreview(file) {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-image" onclick="removeImage('${file.name}')">×</button>
            `;
            previewContainer.appendChild(previewDiv);
        };
        
        reader.readAsDataURL(file);
    }

    window.removeImage = function(fileName) {
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);
        updateFileInput();
        updatePreviewDisplay();
    }

    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => {
            dataTransfer.items.add(file);
        });
        imageInput.files = dataTransfer.files;
    }

    function updatePreviewDisplay() {
        previewContainer.innerHTML = '';
        selectedFiles.forEach(file => {
            displayPreview(file);
        });
    }
</script>
{% endblock %}